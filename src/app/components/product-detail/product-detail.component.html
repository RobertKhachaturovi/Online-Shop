<div class="product-detail-container">
    <div class="loading-container" *ngIf="loading">
        <div class="loading-spinner"></div>
        <p>{{ 'LOADING_PRODUCT' | translate }}</p>
    </div>
    <div class="error-container" *ngIf="error">
        <mat-icon>error</mat-icon>
        <h2>{{ 'ERROR_LOADING' | translate }}</h2>
        <p>{{ 'SOMETHING_WENT_WRONG' | translate }}</p>
        <button mat-raised-button color="primary" (click)="goBack()">{{ 'GO_BACK' | translate }}</button>
    </div>
    <div class="product-detail-content" *ngIf="!loading && !error && product">


        <div class="product-main">
            <div class="product-images">
                <div class="carousel-container" *ngIf="product.images && product.images.length > 0">
                    <button class="carousel-arrow left" (click)="prevImage($event)">
                        <mat-icon>chevron_left</mat-icon>
                    </button>
                    <div class="main-image">
                        <img [src]="product.images[selectedImageIndex]" [alt]="product.title" />
                        <div class="discount-badge" *ngIf="getDiscountPercentage() > 0">
                            -{{ getDiscountPercentage() }}%
                        </div>
                    </div>
                    <button class="carousel-arrow right" (click)="nextImage($event)">
                        <mat-icon>chevron_right</mat-icon>
                    </button>
                </div>
                <div class="image-thumbnails" *ngIf="product.images.length > 1">
                    <div class="thumbnail" *ngFor="let image of product.images; let i = index"
                        [class.active]="i === selectedImageIndex" (click)="selectImage(i)">
                        <img [src]="image" [alt]="product.title" />
                    </div>
                </div>
            </div>
            <div class="product-info">
                <div class="product-header">
                    <h1 class="product-title">{{ product.title }}</h1>
                    <div class="product-rating" *ngIf="product.rating">
                        <div class="stars">
                            <span class="star" *ngFor="let star of [1,2,3,4,5]">
                                <mat-icon [ngClass]="{'filled': star <= Math.round(product.rating)}">
                                    {{ star <= Math.round(product.rating) ? 'star' : 'star_border' }} </mat-icon>
                            </span>
                        </div>
                        <span class="rating-value">{{ product.rating | number:'1.1-1' }}</span>
                    </div>
                </div>
                <div class="price-section">
                    <ng-container
                        *ngIf="product.price?.beforeDiscount && product.price?.beforeDiscount > product.price?.current; else noDiscount">
                        <div class="price-row">
                            <span class="old-price">{{ product.price.beforeDiscount }} {{ product.price.currency
                                }}</span>
                            <span class="new-price">{{ product.price.current }} {{ product.price.currency }}</span>
                        </div>
                        <div class="discount-info">{{ 'SAVE' | translate: {amount: product.price.beforeDiscount - product.price.current, currency: product.price.currency} }}</div>
                    </ng-container>
                    <ng-template #noDiscount>
                        <div class="price-row">
                            <span class="regular-price">{{ product.price?.current || product.price }} {{
                                product.price?.currency || 'â‚¾' }}</span>
                        </div>
                    </ng-template>
                </div>
                <div class="stock-status" [class.in-stock]="isInStock()" [class.out-of-stock]="!isInStock()">
                    <span [ngClass]="isInStock() ? 'stock-green-underline' : 'stock-red-underline'">
                        <ng-container *ngIf="isInStock()">
                            {{ product.stock }} {{ 'IN_STOCK_DETAIL' | translate }}
                        </ng-container>
                        <ng-container *ngIf="!isInStock()">
                            {{ product.stock }} {{ 'NOT_IN_STOCK_DETAIL' | translate }}
                        </ng-container>
                    </span>
                    <mat-icon>{{ isInStock() ? 'check_circle' : 'cancel' }}</mat-icon>
                </div>
                <div class="rating-section">
                    <button mat-raised-button color="accent" class="rating-btn" (click)="openRatingModal()">
                        <mat-icon>star_rate</mat-icon>
                        {{ 'RATING' | translate }}
                    </button>
                </div>
                <div class="add-to-cart-section">
                    <button mat-raised-button color="primary" class="add-to-cart-btn" [disabled]="!isInStock()"
                        (click)="addToCart(product._id)">
                        <mat-icon>shopping_cart</mat-icon>
                        {{ 'ADD_TO_CART' | translate }}
                    </button>
                </div>
                <div class="product-description-section">
                    <section class="guests-section">
                        <h2 class="guests-favorite">{{ 'DESCRIPTION' | translate }}</h2>
                    </section>
                    <div class="description-content">
                        <p>{{ product.description || ('NO_DESCRIPTION_AVAILABLE' | translate) }}</p>
                    </div>
                </div>
                <div class="features-section">
                    <div class="feature">
                        <mat-icon>verified</mat-icon>
                        <span>{{ 'WARRANTY' | translate }}</span>
                    </div>
                    <div class="feature">
                        <mat-icon>security</mat-icon>
                        <span>{{ 'SECURE_PAYMENT' | translate }}</span>
                    </div>
                    <div class="feature">
                        <mat-icon>local_shipping</mat-icon>
                        <span>{{ 'WORLDWIDE_SHIPPING' | translate }}</span>
                    </div>
                </div>
                <div class="product-details">
                    <div class="detail-row">
                        <span class="detail-label">{{ 'CATEGORY' | translate }}</span>
                        <span class="detail-value">{{ product.category?.name }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">{{ 'BRAND' | translate }}</span>
                        <span class="detail-value">{{ product.brand }}</span>
                    </div>
                    <div class="detail-row" *ngIf="product.issueDate">
                        <span class="detail-label">{{ 'ISSUE_DATE' | translate }}</span>
                        <span class="detail-value">{{ product.issueDate | date:'yyyy-MM-dd' }}</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="tabs-section">
            <mat-tab-group (selectedTabChange)="onTabChange($event)" [selectedIndex]="selectedTabIndex">
                <mat-tab [label]="'REVIEWS' | translate">
                    <div class="tab-content">


                        <div class="reviews-section">
                            <div class="reviews-header">
                                <h2>{{ 'REVIEWS_COUNT' | translate: {count: reviews.length} }}</h2>
                                <button mat-raised-button color="primary" class="add-review-btn"
                                    (click)="openRatingModal()">
                                    <mat-icon>add</mat-icon>
                                    {{ 'ADD_REVIEW' | translate }}
                                </button>
                            </div>

                            <div class="reviews-list" *ngIf="reviews.length > 0">
                                <div class="review-item" *ngFor="let review of reviews">
                                    <div class="review-header">
                                        <div class="reviewer-info">
                                            <span class="reviewer-name">{{ review.reviewerName }} {{
                                                review.reviewerLastName }}</span>
                                            <span class="review-date">{{ review.date | date:'dd/MM/yyyy' }}</span>
                                        </div>
                                        <div class="review-actions">
                                            <div class="review-rating">
                                                <div class="stars">
                                                    <span class="star" *ngFor="let star of [1,2,3,4,5]">
                                                        <mat-icon [ngClass]="{'filled': star <= review.rating}">
                                                            {{ star <= review.rating ? 'star' : 'star_border' }}
                                                                </mat-icon>
                                                    </span>
                                                </div>
                                                <span class="rating-value">{{ review.rating }}</span>
                                            </div>
                                            <button class="delete-review-btn" (click)="deleteReview(review.id)"
                                                [title]="'DELETE_REVIEW' | translate">
                                                <mat-icon>delete</mat-icon>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="review-comment" *ngIf="review.comment">
                                        <p>{{ review.comment }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="no-reviews-message" *ngIf="reviews.length === 0">
                                <p>{{ 'NO_REVIEWS' | translate }}</p>
                            </div>
                            <div class="back-button-container">
                                <button class="back-button" (click)="goBack()">
                                    <mat-icon>arrow_back</mat-icon>
                                    {{ 'BACK_TO_PRODUCTS' | translate }}
                                </button>
                            </div>
                        </div>
                    </div>
                </mat-tab>
            </mat-tab-group>
        </div>


    </div>
    <div class="cart-animation-overlay" *ngIf="showCartAnimation" (click)="closeCartAnimation()">
        <div class="cart-animation-container" (click)="$event.stopPropagation()">
            <div class="animation-line"></div>
            <div class="animation-photo">
                <img src="https://img.freepik.com/free-psd/3d-rendering-shopping-concept_23-2149877650.jpg?semt=ais_hybrid&w=740"
                    alt="Cart Animation" />
            </div>
            <div class="animation-text">

                <span>{{ 'ADDED_TO_CART_SUCCESS' | translate }}</span>
                <mat-icon>check_circle</mat-icon>
                <div class="subtitle">{{ 'ITEM_ADDED_SUCCESS' | translate }}</div>
            </div>

        </div>
    </div>
    <div class="rating-modal-overlay" *ngIf="showRatingModal" (click)="closeRatingModal()">
        <div class="rating-modal-container" (click)="$event.stopPropagation()">
            <div class="rating-modal-header">
                <h2>{{ 'ADD_RATING' | translate }}</h2>
                <button class="close-btn" (click)="closeRatingModal()">
                    <mat-icon>close</mat-icon>
                </button>
            </div>

            <div class="rating-modal-content">
                <div class="rating-stars-section">
                    <h3>{{ 'RATING_LABEL' | translate }}</h3>
                    <div class="rating-stars">
                        <span class="star" *ngFor="let star of [1,2,3,4,5]" (click)="setRating(star)">
                            <mat-icon [ngClass]="{'filled': star <= rating}">
                                {{ star <= rating ? 'star' : 'star_border' }} </mat-icon>
                        </span>
                    </div>
                    <p class="rating-text" *ngIf="rating > 0">{{ rating }} {{ 'STARS' | translate }}</p>
                </div>

                <div class="reviewer-info-section">
                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>{{ 'FIRST_NAME' | translate }}</mat-label>
                        <input matInput [(ngModel)]="reviewerName" [placeholder]="'ENTER_FIRST_NAME' | translate">
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>{{ 'LAST_NAME' | translate }}</mat-label>
                        <input matInput [(ngModel)]="reviewerLastName" [placeholder]="'ENTER_LAST_NAME' | translate">
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>{{ 'REVIEW_COMMENT' | translate }}</mat-label>
                        <textarea matInput [(ngModel)]="reviewComment" [placeholder]="'WRITE_REVIEW' | translate"
                            rows="3"></textarea>
                    </mat-form-field>
                </div>

                <div class="rating-modal-actions">
                    <button mat-button (click)="closeRatingModal()">{{ 'CANCEL' | translate }}</button>
                    <button mat-raised-button color="primary" (click)="submitRating()">{{ 'OK' | translate }}</button>
                </div>
            </div>
        </div>
    </div>
</div>