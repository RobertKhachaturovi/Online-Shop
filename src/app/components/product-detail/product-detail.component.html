<div class="product-detail-container">
    <div class="loading-container" *ngIf="loading">
        <div class="loading-spinner"></div>
        <p>Loading product details...</p>
    </div>
    <div class="error-container" *ngIf="error">
        <mat-icon>error</mat-icon>
        <h2>Error loading product</h2>
        <p>Something went wrong. Please try again.</p>
        <button mat-raised-button color="primary" (click)="goBack()">Go Back</button>
    </div>
    <div class="product-detail-content" *ngIf="!loading && !error && product">


        <div class="product-main">
            <div class="product-images">
                <div class="carousel-container" *ngIf="product.images && product.images.length > 0">
                    <button class="carousel-arrow left" (click)="prevImage($event)">
                        <mat-icon>chevron_left</mat-icon>
                    </button>
                    <div class="main-image">
                        <img [src]="product.images[selectedImageIndex]" [alt]="product.title" />
                        <div class="discount-badge" *ngIf="getDiscountPercentage() > 0">
                            -{{ getDiscountPercentage() }}%
                        </div>
                    </div>
                    <button class="carousel-arrow right" (click)="nextImage($event)">
                        <mat-icon>chevron_right</mat-icon>
                    </button>
                </div>
                <div class="image-thumbnails" *ngIf="product.images.length > 1">
                    <div class="thumbnail" *ngFor="let image of product.images; let i = index"
                        [class.active]="i === selectedImageIndex" (click)="selectImage(i)">
                        <img [src]="image" [alt]="product.title" />
                    </div>
                </div>
            </div>
            <div class="product-info">
                <div class="product-header">
                    <h1 class="product-title">{{ product.title }}</h1>
                    <div class="product-rating" *ngIf="product.rating">
                        <div class="stars">
                            <span class="star" *ngFor="let star of [1,2,3,4,5]">
                                <mat-icon [ngClass]="{'filled': star <= Math.round(product.rating)}">
                                    {{ star <= Math.round(product.rating) ? 'star' : 'star_border' }} </mat-icon>
                            </span>
                        </div>
                        <span class="rating-value">{{ product.rating | number:'1.1-1' }}</span>
                    </div>
                </div>
                <div class="price-section">
                    <ng-container
                        *ngIf="product.price?.beforeDiscount && product.price?.beforeDiscount > product.price?.current; else noDiscount">
                        <div class="price-row">
                            <span class="old-price">{{ product.price.beforeDiscount }} {{ product.price.currency
                                }}</span>
                            <span class="new-price">{{ product.price.current }} {{ product.price.currency }}</span>
                        </div>
                        <div class="discount-info">Save {{ product.price.beforeDiscount - product.price.current }} {{
                            product.price.currency }}</div>
                    </ng-container>
                    <ng-template #noDiscount>
                        <div class="price-row">
                            <span class="regular-price">{{ product.price?.current || product.price }} {{
                                product.price?.currency || '₾' }}</span>
                        </div>
                    </ng-template>
                </div>
                <div class="stock-status" [class.in-stock]="isInStock()" [class.out-of-stock]="!isInStock()">
                    <span [ngClass]="isInStock() ? 'stock-green-underline' : 'stock-red-underline'">
                        <ng-container *ngIf="isInStock()">
                            {{ product.stock }} in stock
                        </ng-container>
                        <ng-container *ngIf="!isInStock()">
                            {{ product.stock }} not in stock
                        </ng-container>
                    </span>
                    <mat-icon>{{ isInStock() ? 'check_circle' : 'cancel' }}</mat-icon>
                </div>
                <div class="rating-section">
                    <button mat-raised-button color="accent" class="rating-btn" (click)="openRatingModal()">
                        <mat-icon>star_rate</mat-icon>
                        შეფასება
                    </button>
                </div>
                <div class="add-to-cart-section">
                    <button mat-raised-button color="primary" class="add-to-cart-btn" [disabled]="!isInStock()"
                        (click)="addToCart(product._id)">
                        <mat-icon>shopping_cart</mat-icon>
                        Add to Cart
                    </button>
                </div>
                <div class="product-description-section">
                    <section class="guests-section">
                        <h2 class="guests-favorite">DESCRIPTION</h2>
                    </section>
                    <div class="description-content">
                        <p>{{ product.description || 'აღწერა არ არის ხელმისაწვდომი' }}</p>
                    </div>
                </div>
                <div class="features-section">
                    <div class="feature">
                        <mat-icon>verified</mat-icon>
                        <span>2 Year full warranty</span>
                    </div>
                    <div class="feature">
                        <mat-icon>security</mat-icon>
                        <span>Secure payment</span>
                    </div>
                    <div class="feature">
                        <mat-icon>local_shipping</mat-icon>
                        <span>Worldwide shipping</span>
                    </div>
                </div>
                <div class="product-details">
                    <div class="detail-row">
                        <span class="detail-label">Category:</span>
                        <span class="detail-value">{{ product.category?.name }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Brand:</span>
                        <span class="detail-value">{{ product.brand }}</span>
                    </div>
                    <div class="detail-row" *ngIf="product.issueDate">
                        <span class="detail-label">Issue Date:</span>
                        <span class="detail-value">{{ product.issueDate | date:'yyyy-MM-dd' }}</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="tabs-section">
            <mat-tab-group (selectedTabChange)="onTabChange($event)" [selectedIndex]="selectedTabIndex">
                <mat-tab label="შეფასებები">
                    <div class="tab-content">


                        <div class="reviews-section">
                            <div class="reviews-header">
                                <h2>შეფასებები ({{ reviews.length }})</h2>
                                <button mat-raised-button color="primary" class="add-review-btn"
                                    (click)="openRatingModal()">
                                    <mat-icon>add</mat-icon>
                                    შეფასების დამატება
                                </button>
                            </div>

                            <div class="reviews-list" *ngIf="reviews.length > 0">
                                <div class="review-item" *ngFor="let review of reviews">
                                    <div class="review-header">
                                        <div class="reviewer-info">
                                            <span class="reviewer-name">{{ review.reviewerName }} {{
                                                review.reviewerLastName }}</span>
                                            <span class="review-date">{{ review.date | date:'dd/MM/yyyy' }}</span>
                                        </div>
                                        <div class="review-actions">
                                            <div class="review-rating">
                                                <div class="stars">
                                                    <span class="star" *ngFor="let star of [1,2,3,4,5]">
                                                        <mat-icon [ngClass]="{'filled': star <= review.rating}">
                                                            {{ star <= review.rating ? 'star' : 'star_border' }}
                                                                </mat-icon>
                                                    </span>
                                                </div>
                                                <span class="rating-value">{{ review.rating }}</span>
                                            </div>
                                            <button class="delete-review-btn" (click)="deleteReview(review.id)"
                                                title="შეფასების წაშლა">
                                                <mat-icon>delete</mat-icon>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="review-comment" *ngIf="review.comment">
                                        <p>{{ review.comment }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="no-reviews-message" *ngIf="reviews.length === 0">
                                <p>ჯერ არ არის შეფასებები. დაამატე პირველი შეფასება!</p>
                            </div>
                            <div class="back-button-container">
                                <button class="back-button" (click)="goBack()">
                                    <mat-icon>arrow_back</mat-icon>
                                    Back to Products
                                </button>
                            </div>
                        </div>
                    </div>
                </mat-tab>
            </mat-tab-group>
        </div>


    </div>
    <div class="cart-animation-overlay" *ngIf="showCartAnimation" (click)="closeCartAnimation()">
        <div class="cart-animation-container" (click)="$event.stopPropagation()">
            <div class="animation-line"></div>
            <div class="animation-photo">
                <img src="https://img.freepik.com/free-psd/3d-rendering-shopping-concept_23-2149877650.jpg?semt=ais_hybrid&w=740"
                    alt="Cart Animation" />
            </div>
            <div class="animation-text">
                <mat-icon>check_circle</mat-icon>
                <span>Added to Cart!</span>
                <div class="subtitle">Your item has been successfully added</div>
            </div>
        </div>
    </div>
    <div class="rating-modal-overlay" *ngIf="showRatingModal" (click)="closeRatingModal()">
        <div class="rating-modal-container" (click)="$event.stopPropagation()">
            <div class="rating-modal-header">
                <h2>შეფასების დამატება</h2>
                <button class="close-btn" (click)="closeRatingModal()">
                    <mat-icon>close</mat-icon>
                </button>
            </div>

            <div class="rating-modal-content">
                <div class="rating-stars-section">
                    <h3>რეიტინგი</h3>
                    <div class="rating-stars">
                        <span class="star" *ngFor="let star of [1,2,3,4,5]" (click)="setRating(star)">
                            <mat-icon [ngClass]="{'filled': star <= rating}">
                                {{ star <= rating ? 'star' : 'star_border' }} </mat-icon>
                        </span>
                    </div>
                    <p class="rating-text" *ngIf="rating > 0">{{ rating }} ვარსკვლავი</p>
                </div>

                <div class="reviewer-info-section">
                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>სახელი</mat-label>
                        <input matInput [(ngModel)]="reviewerName" placeholder="შეიყვანეთ თქვენი სახელი">
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>გვარი</mat-label>
                        <input matInput [(ngModel)]="reviewerLastName" placeholder="შეიყვანეთ თქვენი გვარი">
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>შეფასების კომენტარი</mat-label>
                        <textarea matInput [(ngModel)]="reviewComment" placeholder="დაწერეთ თქვენი შეფასება"
                            rows="3"></textarea>
                    </mat-form-field>
                </div>

                <div class="rating-modal-actions">
                    <button mat-button (click)="closeRatingModal()">გაუქმება</button>
                    <button mat-raised-button color="primary" (click)="submitRating()">OK</button>
                </div>
            </div>
        </div>
    </div>
</div>